// Generated by CoffeeScript 1.6.3
var Player, sync;

sync = {
  'GDrive': {
    'key': '361504558285.apps.googleusercontent.com',
    "scope": "https://www.googleapis.com/auth/drive",
    "app_name": "tetris"
  }
};

Nimbus.Auth.setup(sync);

window.realtime_update_callback = function() {
  return console.log('updated...');
};

Player = Nimbus.Model.setup('Player', ['userid', 'name', 'online', 'board', 'piece', 'restart']);

Player.prototype.child = function(key) {
  var i, keys, result;
  key = key.toString();
  result = Player.all();
  keys = key.split('/');
  i = 0;
  while (i < keys.length) {
    result = result[keys[i]];
    i++;
  }
  return result;
};

Nimbus.Auth.set_app_ready(function() {
  if (Nimbus.Auth.authorized()) {
    $('#login').text('Logout');
    return Nimbus.Share.get_me(function(me) {
      var collabrators, one, player, _i, _j, _len, _len1, _ref, _results;
      fill_player(me);
      player = Player.findByAttribute('userid', me.id);
      new Tetris.Controller(player);
      collabrators = doc.getCollaborators();
      console.log(collabrators);
      _ref = Player.all();
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        player = _ref[_i];
        player.online = false;
        for (_j = 0, _len1 = collabrators.length; _j < _len1; _j++) {
          one = collabrators[_j];
          console.log('player ' + player.name + ' online');
          if (one.userId === player.userid) {
            player.online = true;
          }
          player.save();
          break;
        }
        _results.push(player.save());
      }
      return _results;
    });
  }
});

window.set_player = function(data, target) {
  var player;
  player = Player.findByAttribute('userid', data.id);
  if (!player) {
    player = Player.create();
    player.email = data.email;
    player.userid = data.id;
    player.name = data.name;
  }
  player.online = true;
  return player.save();
};

window.fill_player = function(user) {
  var player, players, _i, _len;
  players = Player.all();
  if (players.length < 2) {
    set_player(user);
    return;
  }
  for (_i = 0, _len = players.length; _i < _len; _i++) {
    player = players[_i];
    if (player.userid === user.id) {
      player.online = true;
      player.save();
      return;
    } else if (!player.online) {
      player.destroy();
      set_player(user);
      return;
    }
  }
  return console.log('waiting...');
};

$(function() {
  console.log('ready');
  $('a#login').click(function() {
    console.log('auth start...');
    Nimbus.Auth.authorize('GDrive');
    return false;
  });
  $('#invite').click(function() {
    var email;
    email = $('#invite_email').val();
    Nimbus.Share.add_share_user_real(email, function(user) {
      return fill_player(user);
    });
    return false;
  });
  return true;
});
